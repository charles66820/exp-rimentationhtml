<script src="assets/js/jquery-3.3.1.min.js"></script>
<link href="assets/css/bootstrap.min.css" rel="stylesheet">
<style>
  .addx{
    vertical-align: middle;
    position: relative;
    width: 80px;
    height: 80px;
    display: inline-block;
    box-shadow: 0 0 2px 0px rgba(0,0,0,0.2);
    margin: 0 2px;
    cursor: pointer;
  }
  .addx:hover{
    background-color: #f8f8f8;
  }
  .line-x{
    top: calc(50% - 12px);
    left: calc(50% - 40px);
    width: 80px;
    height: 24px;
    background-color: #eee;
    position: absolute;
    border-radius: 8px;
  }
  .line-y{
    top: calc(50% - 40px);
    left: calc(50% - 12px);
    width: 24px;
    height: 80px;
    background-color: #eee;
    position: absolute;
    border-radius: 8px;
  }
</style>

<!-- gestion des image -->
<div class="col-xl-6">
  <div class="m-2" style="overflow:auto; position:relative">
    <img class="rounded mx-auto d-block" id="imgproduit" src="" data-bs-hover-animate="pulse" style="width:422px; max-width:none; height:385px;">
    <button type="button" class="btn btn-danger" id="btmremoveimgproduit">X</button>
    <button type="button" class="btn btn-warnig" id="btmmodifiimgproduit">changer l'image</button>
    <div id="addimgproduit" style="position:absolute; background-color:pink; top:0; left:0; width:100%; height:100%; min-width:422px; display:none">
      <button type="button" class="btn btn-warnig" style="display:none" id="btmcancelmodifiimgproduit">annuler</button>
    </div>
      <input type="file" style="display:none;">
  </div>
  <div class="m-2" id="listimgproduit">
    <div class="addx" id="btmaddimgproduit">
      <div class="line-x"></div>
      <div class="line-y"></div>
    </div>
  </div>
</div>
<script>
$(function() {
  //a supprimer
  let locimg = localStorage.getItem("images");
  locimg = JSON.parse(locimg);
  for (var i = 0; i < locimg.length; i++) {
    $('<img src="assets/img/imageuploads/'+locimg[i].imagename+'" data-image-id="'+locimg[i].id+'" style="width:80px;height: 80px; margin:0 2px">').insertBefore($("#listimgproduit div:first"));
  }

  //variable
  let buttonactive = true;//let = var
  let images = [];
  let indeximage;
  let listimgproduit = document.getElementById('listimgproduit');

  //function & methods
  String.prototype.getFilename = function(extension){
    var s= this.replace(/\\/g, '/');
    s= s.substring(s.lastIndexOf('/')+ 1);
    return extension? s.replace(/[?#].+$/, ''): s;
  }

  //affichie image avec son index
  function showimgbyindex() {
    console.log(indeximage);
    if (listimgproduit.children[indeximage].src != "") {
      $("#imgproduit").attr("src", listimgproduit.children[indeximage].src);
      $("#addimgproduit").hide();
    }else {
      $("#addimgproduit").show();
      console.log(listimgproduit.children[indeximage].currentSrc);
    }
  }

  //ajoute une image
  function addimg() {
    $("#btmcancelmodifiimgproduit").hide();
    $("#addimgproduit").show();
    $("#btmaddimgproduit").css({"cursor":"not-allowed"});
    $('<img src="" data-image-id="" style="width:80px;height: 80px; margin:0 2px">').insertBefore($("#listimgproduit div:first"));
    indeximage = listimgproduit.children.length-2;
    console.log(indeximage);
  }

  //récupére les image existente
  for (var i = 0; i < listimgproduit.children.length-1; i++) {
    images.push(
      {
        "id":listimgproduit.children[i].getAttribute('data-image-id'),
        "imagename":listimgproduit.children[i].getAttribute('src').getFilename()
      }
    );
  }

  //inisialisation
  if (listimgproduit.children.length-1 != 0) {
    indeximage = 0;
    showimgbyindex();
  }else {
    addimg();
  }


  console.log(JSON.stringify(images));


  //affiche l'image de la liste qui a aiter cliquer
  $("#listimgproduit").click(function(e) {
    if (e.target.localName == 'img') {
      let index = 0;
      while (e.target.parentNode.children[index] != e.target){
        index++;
      }
      indeximage = index;
      console.log(indeximage);
      if (e.target.currentSrc != "") {
        $("#imgproduit").attr("src", e.target.src);
        $("#addimgproduit").hide();
      }else {
        $("#btmcancelmodifiimgproduit").hide();
        $("#addimgproduit").show();
      }
    }
  })


  $("#btmaddimgproduit").click(function() {
    if (buttonactive) {
      addimg();
      buttonactive = false;
    }
  });

  //supprimer image
  $("#btmremoveimgproduit").click(function() {
    //supprimer du json
    images.splice(indeximage, 1);
    $('#listimgproduit').find('img').eq(indeximage).remove();
    //supprimer l'image sur le serveur
    console.log(JSON.stringify(images));
    localStorage.setItem("images", JSON.stringify(images));//a supprimer & remplacer par l'ajax php
    if (listimgproduit.children.length-1 <= 0) {//si il n'y a pas d'autre image
      buttonactive = true;
      addimg();

    }else if (indeximage == listimgproduit.children.length-1) {//si c'est la derniére image
      //afiicher image précédende
      indeximage--;
      showimgbyindex();

    }else {
      //sinon afficher limage suivante
      indeximage;
      showimgbyindex();
    }

  })

  $("#btmmodifiimgproduit").click(function() {
    $("#btmcancelmodifiimgproduit").show();
    $("#addimgproduit").show();
  })

  $("#btmcancelmodifiimgproduit").click(function(e) {
    $("#btmcancelmodifiimgproduit").hide();
    $("#addimgproduit").hide();
    e.stopPropagation();
  })

  //désactive l'ouverture des fichier au moment du drop
  document.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
  });
  document.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.dataTransfer.effectAllowed = "none";
    e.dataTransfer.dropEffect = "none";
    e.stopPropagation();
  });
  document.getElementById('addimgproduit').addEventListener('dragover', function(e) {
    e.preventDefault();
    e.dataTransfer.effectAllowed = "copy";
    e.dataTransfer.dropEffect = "copy";
    e.stopPropagation();
  });

  //change le style et envois le fichier en fonction du drag/drop
  $("#addimgproduit").on("dragover", function(e) {
    e.preventDefault();
    $(this).css({"border":"solid 2px rgba(0, 120, 255, 1)", "background-color":"rgb(150, 210, 255)"})
    return false;
  }).on("dragleave", function() {
    $(this).css({"border":"none", "background-color":""})
  }).on("click", function() {
    $(this).next().click();
  }).next().on("change", function(e){
    uploadimg(e.target.files[0])
  })
  document.getElementById('addimgproduit').ondrop = function(e) {
    $(this).css({"border":"none", "background-color":""});
    e.preventDefault();
    uploadimg(e.dataTransfer.files[0]);
    e.stopPropagation();
  }

  //ajax uploade de l'image
  function uploadimg(files) {
    var formData = new FormData();
    formData.append('upload', '');
    formData.append('image', files);
    $.ajax({
      url: "assets/php/dropToUploadFiles.php",
      method: "post",
      data: formData,
      contentType: false,
      processData: false,
      success: function (result) {
        //test si c'est une nouvelle image
        if (indeximage == listimgproduit.children.length-2 && listimgproduit.children[listimgproduit.children.length-2].currentSrc == "") {//try this
          images.push({"id":null,"imagename":result});
          $("#btmaddimgproduit").css({"cursor":"pointer"});
          buttonactive = true;
        }else {
          images[indeximage].imagename = result;
          console.log(images[indeximage].imagename = result);
        }

        localStorage.setItem("images", JSON.stringify(images));//a supprimer & remplacer par l'ajax php

        $('#listimgproduit').find('img').eq(indeximage).attr('src', 'assets/img/imageuploads/'+result);
        console.log(JSON.stringify(images));
        showimgbyindex()
        $("#addimgproduit").hide();
      },
      error: function (error) { console.log("Error Upload : "+error); }
    })
  }
});
</script>
